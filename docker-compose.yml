services:
  traefik:
    image: traefik:v3
    container_name: vempain-site-traefik
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
    ports:
      - "127.0.0.1:80:80"
      - "127.0.0.1:8080:8080"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "./traefik/letsencrypt:/letsencrypt"
    networks:
      - vempain-web-site

  vempain-site-frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: vempain-site-frontend
    volumes:
      - ${VEMPAIN_WEBSITE_WEB_ROOT:-/tmp/vempain-files}:/files:ro
    networks:
      - vempain-web-site
    depends_on:
      vempain-site-backend:
        condition: service_healthy
    labels:
      - 'traefik.enable=true'
      - 'traefik.docker.network=vempain-web-site'
      - 'traefik.http.routers.vempain-site-frontend.rule=Host("${TRAEFIK_SITE_HOST}")'
      - 'traefik.http.routers.vempain-site-frontend.entrypoints=web'
      - 'traefik.http.routers.vempain-site-frontend.priority=1'
      - 'traefik.http.services.vempain-site-frontend.loadbalancer.server.port=80'
      - 'traefik.http.routers.vempain-site-frontend-http.rule=Host("${TRAEFIK_SITE_HOST}")'
      - 'traefik.http.routers.vempain-site-frontend-http.entrypoints=web'
      - 'traefik.http.routers.vempain-site-frontend-http.priority=1'
      - 'traefik.http.routers.vempain-site-frontend-http.service=frontend'

  vempain-site-backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: vempain-site-backend
    environment:
      APP_ENV: ${APP_ENV:-prod}
      APP_DEBUG: ${APP_DEBUG:-false}
      ENV_VEMPAIN_SITE_DB_HOST: ${ENV_VEMPAIN_SITE_DB_HOST}
      ENV_VEMPAIN_SITE_DB_PORT: ${ENV_VEMPAIN_SITE_DB_PORT}
      ENV_VEMPAIN_SITE_DB_NAME: ${ENV_VEMPAIN_SITE_DB_NAME:-vempain}
      ENV_VEMPAIN_SITE_DB_USER: ${ENV_VEMPAIN_SITE_DB_USER:-vempain}
      ENV_VEMPAIN_SITE_DB_PASSWORD: ${ENV_VEMPAIN_SITE_DB_PASSWORD}
      ENV_VEMPAIN_SITE_DB_SCHEMA: ${ENV_VEMPAIN_SITE_DB_SCHEMA:-vempain_site}
      JWT_SECRET: ${JWT_SECRET}
      JWT_TTL_SECONDS: ${JWT_TTL_SECONDS:-1200}
      VEMPAIN_WEBSITE_WEB_ROOT: /files
    volumes:
      - ./backend:/var/www/backend
      - ${VEMPAIN_WEBSITE_WEB_ROOT:-/tmp/vempain-files}:/files:ro
      - ${ENV_VEMPAIN_SITE_LOG_VOLUME:-/var/tmp/vempain-site-logs}:/var/log/vempain
    networks:
      - vempain-web-site
    depends_on:
      vempain-site-db:
        condition: service_healthy
      vempain-admin-backend:
        condition: service_started
    labels:
      - 'traefik.enable=true'
      - 'traefik.docker.network=vempain'
      - 'traefik.http.routers.backend.rule=Host("${TRAEFIK_SITE_HOST}") && (PathPrefix("/api") || PathPrefix("/file") || PathPrefix("/health"))'
      - 'traefik.http.routers.backend.entrypoints=web'
      - 'traefik.http.routers.backend.priority=10'
      - 'traefik.http.services.backend.loadbalancer.server.port=8000'
      - 'traefik.http.routers.backend-http.rule=Host("${TRAEFIK_SITE_HOST}") && (PathPrefix("/api") || PathPrefix("/file") || PathPrefix("/health"))'
      - 'traefik.http.routers.backend-http.entrypoints=web'
      - 'traefik.http.routers.backend-http.priority=10'
      - 'traefik.http.routers.backend-http.service=backend'
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:8000/health || exit 1" ]
      interval: 20s
      timeout: 5s
      retries: 5

  vempain-site-db:
    image: postgres:17
    ports:
      - "5434:5432"
    environment:
      POSTGRES_DB: ${ENV_VEMPAIN_SITE_DB_NAME:-vempain}
      POSTGRES_USER: ${ENV_VEMPAIN_SITE_DB_USER:-vempain}
      POSTGRES_PASSWORD: ${ENV_VEMPAIN_SITE_DB_PASSWORD}
    volumes:
      - postgres_site_volume:/var/lib/postgresql/data
    networks:
      - vempain-web-site
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${ENV_VEMPAIN_SITE_DB_USER:-vempain} -d ${ENV_VEMPAIN_SITE_DB_NAME:-vempain}" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ---------------- vempain-admin ----------------
  vempain-admin-frontend:
    image: "ghcr.io/vempain/vempain/vempain-admin-frontend:${ENV_VEMPAIN_ADMIN_FRONTEND_VERSION}"
    labels:
      - 'traefik.enable=true'
      - 'traefik.docker.network=vempain'
      # Route everything except /api and /actuator to admin frontend UI
      - 'traefik.http.routers.admin-frontend.rule=Host("${TRAEFIK_ADMIN_HOST}") && !PathPrefix("/api") && !PathPrefix("/actuator")'
      - 'traefik.http.routers.admin-frontend.entrypoints=web'
      - 'traefik.http.routers.admin-frontend.priority=100'
      - 'traefik.http.routers.admin-frontend.service=admin-frontend'
      - 'traefik.http.services.admin-frontend.loadbalancer.server.port=8080'
    expose:
      - "80"
    networks:
      - vempain-web-site
    depends_on:
      - vempain-site-backend
    # healthcheck removed (image doesn't include curl) to avoid unhealthy state

  vempain-admin-backend:
    image: "ghcr.io/vempain/vempain/vempain-admin-backend:${ENV_VEMPAIN_ADMIN_BACKEND_VERSION}"
    environment:
      - spring.profiles.active=prod
      - spring.servlet.multipart.max-file-size=100MB
      - spring.servlet.multipart.max-request-size=120MB
      - spring.servlet.multipart.enabled=true
      - server.tomcat.max-http-form-post-size=120MB
      - server.tomcat.max-swallow-size=-1
      - spring.admin-datasource.url=jdbc:postgresql://vempain-admin-db:5432/vempain_admin_db?currentSchema=vempain_admin&useSSL=false
      - spring.admin-datasource.username=vempain_admin
      - spring.admin-datasource.password=${ENV_VEMPAIN_ADMIN_DB_PASSWORD}
      - spring.site-datasource.url=jdbc:postgresql://${ENV_VEMPAIN_SITE_DB_HOST}:${ENV_VEMPAIN_SITE_DB_PORT}/${ENV_VEMPAIN_SITE_DB_NAME}?currentSchema=${ENV_VEMPAIN_SITE_DB_SCHEMA}&useSSL=false
      - spring.site-datasource.username=${ENV_VEMPAIN_SITE_DB_USER}
      - spring.site-datasource.password=${ENV_VEMPAIN_SITE_DB_PASSWORD}
      - vempain.app.jwt-secret=your_jwt_secret_here
      - vempain.app.jwt-expiration-ms=86400000
      - vempain.test=false
      - vempain.admin.file.site-file-directory=/vempain_admin/site-files
      - vempain.admin.ssh.user=${ENV_VEMPAIN_SITE_SSH_USER}
      - vempain.admin.ssh.home-dir=/vempain_admin/vempain
      - vempain.site.ssh.address=${ENV_VEMPAIN_SITE_ADDRESS}
      - vempain.site.ssh.port=${ENV_VEMPAIN_SITE_SSH_PORT}
      - vempain.site.ssh.user=${ENV_VEMPAIN_SITE_SSH_USER}
      - vempain.site.www-root=${ENV_VEMPAIN_SITE_WWW_ROOT}
      - vempain.site.ssh.home-dir=${ENV_VEMPAIN_SITE_SSH_HOME_DIR}
      - vempain.app.frontend-url=https://${ENV_VEMPAIN_ADMIN_HOSTNAME}
    volumes:
      - ${ENV_VEMPAIN_ADMIN_SITE_FILE_DIR}:/vempain_admin/site-files
      - ${ENV_VEMPAIN_ADMIN_SSH_CONFIG_DIR}:/vempain_admin/vempain/.ssh
    depends_on:
      - vempain-admin-db
      - vempain-site-db
    ports:
      - "5000:8080"
      - "5001:8081"
    labels:
      - 'traefik.enable=true'
      - 'traefik.docker.network=vempain'
      # /api -> admin backend (port 8080)
      - 'traefik.http.routers.vempain-admin-backend.rule=Host("${TRAEFIK_ADMIN_HOST}") && PathPrefix("/api")'
      - 'traefik.http.routers.vempain-admin-backend.entrypoints=web'
      - 'traefik.http.routers.vempain-admin-backend.priority=200'
      - 'traefik.http.routers.vempain-admin-backend.service=vempain-admin-backend'
      - 'traefik.http.services.vempain-admin-backend.loadbalancer.server.port=8080'
      # /actuator -> backend management port (8081)
      - 'traefik.http.routers.admin-actuator.rule=Host("${TRAEFIK_ADMIN_HOST}") && PathPrefix("/actuator")'
      - 'traefik.http.routers.admin-actuator.entrypoints=web'
      - 'traefik.http.routers.admin-actuator.priority=210'
      - 'traefik.http.routers.admin-actuator.service=admin-actuator'
      - 'traefik.http.services.admin-actuator.loadbalancer.server.port=8081'
    networks:
      - vempain-web-site
    expose:
      - "8080"
      - "8081"
    # healthcheck removed to avoid unhealthy status during local dev

  vempain-admin-db:
    image: postgres:17
    environment:
      POSTGRES_DB: ${ENV_VEMPAIN_ADMIN_DB_NAME}
      POSTGRES_USER: ${ENV_VEMPAIN_ADMIN_DB_USER}
      POSTGRES_PASSWORD: ${ENV_VEMPAIN_ADMIN_DB_PASSWORD}
    volumes:
      - postgresdb_admin_volume:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    networks:
      - vempain-web-site

networks:
  vempain-web-site:
    driver: bridge

volumes:
  postgres_site_volume:
  postgresdb_admin_volume:
